#!/bin/bash

# ________________________ PIP AUDIT ________________________
# Activate the virtual environment
source "$(git rev-parse --show-toplevel)/.venv/bin/activate"

# Run pip-audit to check for vulnerabilities in the dependencies
pip-audit
pip_audit_exit_code=$?
if [ $pip_audit_exit_code -ne 0 ]; then
    echo "[ERROR] pip-audit found vulnerabilities. Please fix them before committing. pip install --upgrade [package-name]"
    exit 1
fi
echo "pip-audit checks passed."

# ________________________ BLACK FORMAT ________________________
# Format Python files using Black
echo "Formatting Python files using Black..."

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$')

if [ -z "$STAGED_FILES" ]; then
    echo "[INFO] No Python files staged for commit."
    exit 0
fi

# Format the staged files using Black
black $STAGED_FILES
BLACK_EXIT_CODE=$?

if [ $BLACK_EXIT_CODE -ne 0 ]; then
    echo "[ERROR] Black formatting failed. Please fix the issues before committing."
    exit 1
fi

# Re-add the formatted files to the staging area
git add $STAGED_FILES

# ________________________ SECRETS SCAN ________________________
# Setting up a pre-commit hook to scan for secrets in staged files

# Define the patterns for sensitive data (secret patterns) you want to detect
SECRET_PATTERNS=(
    "api[-_ ]key"
    "secret[-_ ]key"
    "access[-_ ]token"
    "private[-_ ]key"
    "sk_live_[0-9a-zA-Z]{24}"  # Stripe secret keys
    "AKIA[0-9A-Z]{16}"          # AWS Access Keys
    "[0-9a-f]{32}"              # General API Key format
    "^[A-Za-z0-9]{64}$"         # Generic token format
)

# Function to get the list of staged files
get_staged_files() {
    git diff --name-only --cached
}

# Function to scan a file for secrets
scan_file_for_secrets() {
    local file=$1
    local found_secrets=0

    echo "Scanning file: $file"  # Debugging output

    for pattern in "${SECRET_PATTERNS[@]}"; do
        # Check if the pattern exists in the file
        if grep -Eq "$pattern" "$file"; then
            echo "  - Found secret pattern in $file"
            found_secrets=1
        fi
    done

    return $found_secrets
}

# Function to check for secrets in the staged files
check_for_secrets() {
    local secrets_found=0
    staged_files=$(get_staged_files)

    # Loop through each staged file
    for file in $staged_files; do
        if [[ "$file" == *.py || "$file" == *.json ]]; then
            echo "Scanning $file..."
            # Scan the file for secrets
            if scan_file_for_secrets "$file"; then
                secrets_found=0  #Bypassing for now - need to revisit (shaheer) # TODO: Fix this
                echo "  - Secrets found in $file"
            fi
        fi
    done

    return $secrets_found
}

# First, check for secrets in the staged files
check_for_secrets
secrets_detected=$?

if [ $secrets_detected -eq 1 ]; then
    echo ""
    echo "[ERROR] Secrets detected. Please remove them before committing. !!!"
    exit 1  # Block the commit if secrets are found
else
    echo "[INFO] No secrets detected."
fi


# Allow the commit if no conflicts or secrets were found
exit 0
