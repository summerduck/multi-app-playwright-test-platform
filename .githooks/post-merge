#!/bin/bash

# Post-merge hook: synchronize dependencies after merge
# Ensures local environment stays in sync with merged changes

readonly HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(cd "$HOOK_DIR/.." && pwd)"

echo "[INFO] Post-merge hook triggered"
echo "[INFO] Project root: $PROJECT_ROOT"

# Check if dependency files changed between ORIG_HEAD and HEAD
if ! git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '(requirements.*\.txt|pyproject\.toml)'; then
    echo "[INFO] No dependency file changes detected - skipping install"
    echo "[INFO] Post-merge setup complete"
    exit 0
fi

echo "[INFO] Dependency files changed - updating environment..."

# Install dependencies using task runner or pip directly
if command -v task &>/dev/null; then
    if ! task install; then
        echo "[WARN] 'task install' failed - falling back to pip"
        pip install -r "$PROJECT_ROOT/requirements.txt" || echo "[WARN] pip install failed"
    fi
else
    echo "[INFO] 'task' not found - using pip directly"
    pip install -r "$PROJECT_ROOT/requirements.txt" || echo "[WARN] pip install failed"
fi

echo "[INFO] Dependencies updated"

# Verify installed package consistency
echo "[INFO] Verifying dependency integrity..."
if pip check &>/dev/null; then
    echo "[INFO] All dependencies verified"
else
    echo "[WARN] Dependency verification found issues - run 'pip check' for details"
fi

echo "[INFO] Post-merge setup complete"
