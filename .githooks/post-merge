#!/bin/bash
set -e

# Post-merge hook: synchronize dependencies after merge
# Ensures local environment stays in sync with merged changes

readonly HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(cd "$HOOK_DIR/.." && pwd)"

echo "[INFO] Post-merge hook triggered"
echo "[INFO] Project root: $PROJECT_ROOT"

# Update dependencies if package files changed
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '(requirements.*\.txt|pyproject\.toml|poetry\.lock)'; then
    echo "[INFO] Dependency files changed - updating environment..."

    if ! task install; then
        echo "[ERROR] Failed to install dependencies"
        exit 1
    fi

    echo "[INFO] Dependencies updated successfully"
else
    echo "[INFO] No dependency changes detected"
fi

# Verify environment health
echo "[INFO] Verifying dependency integrity..."
if task check-deps; then
    echo "[INFO] All dependencies verified"
else
    echo "[WARN] Dependency verification found issues"
    exit 1
fi

echo "[INFO] Post-merge setup complete"
